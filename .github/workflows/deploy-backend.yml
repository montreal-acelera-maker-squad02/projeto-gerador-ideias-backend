name: CI/CD - Deploy Backend Java

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Backend
        working-directory: backend
        run: mvn clean package -DskipTests

      - name: Deploy Backend with PM2
        shell: powershell
        run: |
          echo "Deploying Backend..."

          $BACKEND_DIR = "E:/Criaitor/projeto-gerador-ideias-backend"
          $PM2 = "C:\Users\marco.filho\AppData\Roaming\npm\pm2.ps1"
          $JAR_SOURCE = "$env:GITHUB_WORKSPACE/backend/target/gerador-ideias-backend-0.0.1-SNAPSHOT.jar"
          $JAR_DEST = "$BACKEND_DIR/gerador-ideias-backend-0.0.1-SNAPSHOT.jar"

          echo "Copiando novo JAR..."
          Copy-Item $JAR_SOURCE $JAR_DEST -Force

          echo "Reiniciando PM2..."
          & $PM2 restart CriaitorBackend 2>$null
          if ($LASTEXITCODE -ne 0) {
            & $PM2 start "E:/Criaitor/ecosystem.config.js" --only CriaitorBackend
          }

          & $PM2 save

          echo "Backend deploy finalizado!"
